# GitLab CI/CD configuration for MFC Q-Learning project
# Uses shell executor with pixi for dependency management

stages:
  - test

variables:
  # Ensure tests run in isolated environment without user site-packages
  PYTHONNOUSERSITE: '1'

# Main test job using pixi (shell executor)
test:
  stage: test
  script:
    - echo "Running tests with pixi on $(hostname)"
    - echo "PYTHONNOUSERSITE=$PYTHONNOUSERSITE"
    # Check if pixi is available, install if needed
    - which pixi || curl -fsSL https://pixi.sh/install.sh | bash
    - export PATH="$HOME/.pixi/bin:$PATH"
    # Install dependencies
    - pixi install -e default
    # Run linting
    - pixi run -e default ruff check q-learning-mfcs/src --output-format=gitlab > ruff-report.json || true
    # Run tests
    - pixi run -e default pytest q-learning-mfcs/tests -v --tb=short --junitxml=report.xml
  artifacts:
    when: always
    paths:
      - report.xml
      - ruff-report.json
    reports:
      junit: report.xml
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "push"
