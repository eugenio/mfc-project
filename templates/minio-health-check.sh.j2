#!/bin/bash
TAILSCALE_HOSTNAME={{ tailscale_hostname }}

echo "=== MinIO Health Check $(date) ==="
echo "Tailscale Status:"
tailscale status | grep -E "(Self|minio)"

echo -e "\nMinIO HTTPS Health:"
curl -s -k https://${TAILSCALE_HOSTNAME}:9000/minio/health/live

echo -e "\nMinIO Container Status:"
cd ~/minio-setup
docker compose ps

echo -e "\nCertificate Expiry:"
echo | openssl s_client -servername ${TAILSCALE_HOSTNAME} -connect ${TAILSCALE_HOSTNAME}:9000 2>/dev/null | openssl x509 -noout -dates

echo -e "\nStorage Usage:"
du -sh {{ minio_data_path }}/

echo -e "\nBucket Status:"
mc ls minio-secure/ 2>/dev/null || echo "MinIO not accessible"

echo -e "\nTailscale Connectivity:"
tailscale ping {{ tailscale_hostname }} 2>/dev/null || echo "Tailscale ping failed"